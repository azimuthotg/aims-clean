{% extends 'base.html' %}

{% block title %}เพิ่มผู้ใช้ใหม่ - AIMS{% endblock %}

{% block breadcrumb %}
<a href="{% url 'dashboard:home' %}" class="text-slate-400 hover:text-slate-600">Dashboard</a>
<span class="mx-2 text-slate-300">/</span>
<a href="{% url 'user_management' %}" class="text-slate-400 hover:text-slate-600">จัดการผู้ใช้งาน</a>
<span class="mx-2 text-slate-300">/</span>
<span class="text-slate-700 font-medium">เพิ่มผู้ใช้ใหม่</span>
{% endblock %}

{% block content %}

<div class="max-w-2xl mx-auto">

    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-xl font-bold text-slate-900">เพิ่มผู้ใช้ใหม่</h1>
        <p class="text-sm text-slate-500 mt-1">กรอกข้อมูลเพื่อสร้างบัญชีผู้ใช้ในระบบ AIMS</p>
    </div>

    <form method="post" id="addUserForm">
        {% csrf_token %}

        <!-- Account Info -->
        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-4">
            <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
                <i class="fas fa-user-plus text-blue-500"></i>
                <h2 class="text-sm font-semibold text-slate-700">ข้อมูลบัญชี</h2>
            </div>
            <div class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="username" class="block text-xs font-medium text-slate-600 mb-1.5">
                        ชื่อผู้ใช้ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="username" id="username" required
                           value="{{ form_data.username|default:'' }}"
                           placeholder="ใช้สำหรับเข้าสู่ระบบ"
                           class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
                <div>
                    <label for="email" class="block text-xs font-medium text-slate-600 mb-1.5">อีเมล</label>
                    <input type="email" name="email" id="email"
                           value="{{ form_data.email|default:'' }}"
                           class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
                <div>
                    <label for="first_name" class="block text-xs font-medium text-slate-600 mb-1.5">
                        ชื่อ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="first_name" id="first_name" required
                           value="{{ form_data.first_name|default:'' }}"
                           class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
                <div>
                    <label for="last_name" class="block text-xs font-medium text-slate-600 mb-1.5">
                        นามสกุล <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="last_name" id="last_name" required
                           value="{{ form_data.last_name|default:'' }}"
                           class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
            </div>
        </div>

        <!-- Role & Department -->
        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-4">
            <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
                <i class="fas fa-building text-blue-500"></i>
                <h2 class="text-sm font-semibold text-slate-700">บทบาทและหน่วยงาน</h2>
            </div>
            <div class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="user_role" class="block text-xs font-medium text-slate-600 mb-1.5">
                        บทบาทผู้ใช้ <span class="text-red-500">*</span>
                    </label>
                    <select name="user_role" id="user_role" required
                            class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white transition-colors">
                        {% for role_key, role_name in user_roles %}
                        <option value="{{ role_key }}"
                            {% if form_data.user_role == role_key or role_key == 'academic_service' and not form_data.user_role %}selected{% endif %}>
                            {{ role_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="phone" class="block text-xs font-medium text-slate-600 mb-1.5">เบอร์โทรศัพท์</label>
                    <input type="text" name="phone" id="phone"
                           value="{{ form_data.phone|default:'' }}"
                           class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
                <div>
                    <label for="department" class="block text-xs font-medium text-slate-600 mb-1.5">หน่วยงาน</label>
                    <input type="text" name="department" id="department"
                           value="{{ form_data.department|default:'สำนักวิทยบริการ' }}"
                           class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
                <div>
                    <label for="division" class="block text-xs font-medium text-slate-600 mb-1.5">แผนก</label>
                    <select name="division" id="division"
                            class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white transition-colors">
                        <option value="">-- กรุณาเลือกแผนก --</option>
                        <option value="information_services" {% if form_data.division == 'information_services' %}selected{% endif %}>แผนกบริการสารสนเทศฯ</option>
                        <option value="technical" {% if form_data.division == 'technical' %}selected{% endif %}>แผนกเทคนิคฯ</option>
                        <option value="policy_planning" {% if form_data.division == 'policy_planning' %}selected{% endif %}>แผนกนโยบายและแผน</option>
                        <option value="general_admin" {% if form_data.division == 'general_admin' %}selected{% endif %}>แผนกบริหารงานทั่วไป</option>
                    </select>
                </div>
                <div class="sm:col-span-2">
                    <label for="position" class="block text-xs font-medium text-slate-600 mb-1.5">ตำแหน่ง</label>
                    <input type="text" name="position" id="position"
                           value="{{ form_data.position|default:'' }}"
                           class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
            </div>
        </div>

        <!-- Auth Type -->
        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-4">
            <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
                <i class="fas fa-lock text-blue-500"></i>
                <h2 class="text-sm font-semibold text-slate-700">ประเภทการเข้าสู่ระบบ</h2>
            </div>
            <div class="p-6">
                <label class="flex items-start gap-3 cursor-pointer mb-2">
                    <input type="checkbox" name="is_ldap_user" id="is_ldap_user"
                           {% if form_data.is_ldap_user|default:True %}checked{% endif %}
                           class="w-4 h-4 mt-0.5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                    <div>
                        <p class="text-sm font-medium text-slate-700">ผู้ใช้ LDAP (เข้าสู่ระบบผ่าน NPU)</p>
                        <p class="text-xs text-slate-400 mt-0.5">ติ๊กถ้าผู้ใช้เข้าสู่ระบบด้วย LDAP ไม่ติ๊กหากต้องการตั้งรหัสผ่านเอง</p>
                    </div>
                </label>

                <!-- Password Section (hidden for LDAP) -->
                <div id="password-section" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                    <div>
                        <label for="password" class="block text-xs font-medium text-slate-600 mb-1.5">รหัสผ่าน</label>
                        <input type="password" name="password" id="password"
                               class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                      focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                        <p class="text-xs text-slate-400 mt-1">สำหรับผู้ใช้ที่ไม่ใช่ LDAP เท่านั้น</p>
                    </div>
                    <div>
                        <label for="password_confirm" class="block text-xs font-medium text-slate-600 mb-1.5">ยืนยันรหัสผ่าน</label>
                        <input type="password" name="password_confirm" id="password_confirm"
                               class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                      focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-6">
            <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
                <i class="fas fa-sticky-note text-slate-400"></i>
                <h2 class="text-sm font-semibold text-slate-700">หมายเหตุ</h2>
            </div>
            <div class="p-6">
                <textarea name="notes" id="notes" rows="3" placeholder="หมายเหตุเพิ่มเติมเกี่ยวกับผู้ใช้นี้"
                          class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm text-slate-900
                                 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent
                                 resize-none transition-colors">{{ form_data.notes|default:'' }}</textarea>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button type="submit"
                        class="flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                    <i class="fas fa-save"></i>บันทึกผู้ใช้ใหม่
                </button>
                <a href="{% url 'user_management' %}"
                   class="flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors">
                    <i class="fas fa-times"></i>ยกเลิก
                </a>
            </div>
            <p class="text-xs text-slate-400"><span class="text-red-500">*</span> ระบุข้อมูลที่จำเป็น</p>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
const ldapCheckbox = document.getElementById('is_ldap_user');
const passwordSection = document.getElementById('password-section');
const passwordInput = document.getElementById('password');
const passwordConfirm = document.getElementById('password_confirm');

function togglePasswordSection() {
    if (ldapCheckbox.checked) {
        passwordSection.classList.add('hidden');
        passwordInput.required = false;
        passwordConfirm.required = false;
    } else {
        passwordSection.classList.remove('hidden');
        passwordInput.required = true;
        passwordConfirm.required = true;
    }
}

ldapCheckbox.addEventListener('change', togglePasswordSection);

document.addEventListener('DOMContentLoaded', function() {
    togglePasswordSection();
});

document.getElementById('addUserForm').addEventListener('submit', function(e) {
    const isLdap = ldapCheckbox.checked;
    const pw = passwordInput.value;
    const pwc = passwordConfirm.value;

    if (!isLdap && pw !== pwc) {
        alert('รหัสผ่านและการยืนยันรหัสผ่านไม่ตรงกัน');
        e.preventDefault();
        return false;
    }
    if (!isLdap && pw.length < 6) {
        alert('รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร');
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}
