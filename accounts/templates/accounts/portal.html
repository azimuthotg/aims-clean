{% extends 'base.html' %}

{% block title %}Portal - AIMS Hub{% endblock %}

{% block breadcrumb %}
<a href="{% url 'dashboard:home' %}" class="text-slate-400 hover:text-slate-600">Dashboard</a>
<span class="mx-2 text-slate-300">/</span>
<span class="text-slate-700 font-medium">Portal</span>
{% endblock %}

{% block content %}

<!-- Welcome Section -->
<div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-6 mb-6 text-white">
    <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center text-2xl font-bold flex-shrink-0 backdrop-blur-sm">
            {{ user.first_name|first|default:user.username|first|upper }}
        </div>
        <div>
            <h1 class="text-xl font-bold leading-snug">ยินดีต้อนรับ, {{ user.get_full_name|default:user.username }}</h1>
            <p class="text-blue-200 text-sm mt-0.5">
                {{ user.get_role_display_thai }}
                {% if user.department %}
                    &mdash; {{ user.department }}
                {% endif %}
            </p>
            {% if user.division %}
            <p class="text-blue-300 text-xs mt-0.5">{{ user.get_division_display_thai }}</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Info Row -->
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
    <div class="bg-white rounded-xl border border-slate-200 p-4 flex items-center gap-4">
        <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-user-clock text-blue-600"></i>
        </div>
        <div>
            <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">เข้าใช้ล่าสุด</p>
            <p class="text-sm font-semibold text-slate-800 mt-0.5">
                {% if user.last_login %}
                    {{ user.last_login|date:"d/m/Y H:i" }}
                {% else %}
                    ยังไม่เคยเข้าใช้
                {% endif %}
            </p>
        </div>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 p-4 flex items-center gap-4">
        <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-shield-alt text-green-600"></i>
        </div>
        <div>
            <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">ระดับสิทธิ์</p>
            <p class="text-sm font-semibold text-slate-800 mt-0.5">{{ user.get_role_display_thai }}</p>
        </div>
    </div>
</div>

<!-- Systems Grid -->
<div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
        <i class="fas fa-th-large text-slate-400"></i>
        <h2 class="text-sm font-semibold text-slate-700">ระบบที่คุณสามารถเข้าใช้งานได้</h2>
    </div>

    <div class="p-6">
        {% if accessible_systems %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for system in accessible_systems %}
            <div class="group relative bg-white rounded-xl border border-slate-200 hover:border-blue-300 hover:shadow-md transition-all duration-200 overflow-hidden">

                <!-- Role badge -->
                <span class="absolute top-3 right-3 px-2 py-0.5 rounded-full text-xs font-medium
                    {% if system.role == 'admin' %}bg-red-100 text-red-700
                    {% elif system.role == 'creator' or system.role == 'uploader' or system.role == 'analyst' %}bg-amber-100 text-amber-700
                    {% elif system.role == 'approver' %}bg-sky-100 text-sky-700
                    {% else %}bg-slate-100 text-slate-600{% endif %}">
                    {{ system.role|upper }}
                </span>

                <div class="p-5">
                    <!-- Icon -->
                    <div class="w-12 h-12 rounded-xl mb-4 flex items-center justify-center
                        {% if system.code == 'aims' %}bg-blue-100
                        {% elif system.code == 'dashboard' %}bg-green-100
                        {% elif system.code == 'document' %}bg-sky-100
                        {% elif system.code == 'planning' %}bg-amber-100
                        {% elif system.code == 'library' %}bg-purple-100
                        {% else %}bg-slate-100{% endif %}">
                        <i class="{{ system.icon }} text-xl
                            {% if system.code == 'aims' %}text-blue-600
                            {% elif system.code == 'dashboard' %}text-green-600
                            {% elif system.code == 'document' %}text-sky-600
                            {% elif system.code == 'planning' %}text-amber-600
                            {% elif system.code == 'library' %}text-purple-600
                            {% else %}text-slate-600{% endif %}">
                        </i>
                    </div>

                    <!-- Name & Description -->
                    <h3 class="font-semibold text-slate-900 text-sm mb-1">{{ system.name }}</h3>
                    <p class="text-xs text-slate-500 leading-relaxed mb-4">
                        {% if system.code == 'aims' %}ระบบจัดการข้อมูลวิชาการและผู้ใช้งาน
                        {% elif system.code == 'dashboard' %}ระบบสถิติและรายงานข้อมูลเชิงวิเคราะห์
                        {% elif system.code == 'document' %}ระบบสารบรรณอิเล็กทรอนิกส์และเอกสาร
                        {% elif system.code == 'planning' %}ระบบจัดการแผนงานและโครงการ
                        {% elif system.code == 'library' %}ระบบจัดการห้องสมุดและทรัพยากร
                        {% elif system.code == 'finance' %}ระบบการเงินและงบประมาณ
                        {% else %}ระบบสำหรับการจัดการข้อมูล{% endif %}
                    </p>

                    <!-- Port info -->
                    <p class="text-xs text-slate-400 mb-4">
                        <i class="fas fa-server mr-1"></i>Port {{ system.port }}
                    </p>

                    <!-- CTA Button -->
                    {% if system.code == 'aims' %}
                    <a href="{{ system.url }}"
                       class="flex items-center justify-center gap-2 w-full px-4 py-2 rounded-lg text-sm font-medium
                              bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                        <i class="fas fa-home"></i>เข้าใช้งาน
                    </a>
                    {% else %}
                    <a href="{{ system.url }}" target="_blank"
                       class="flex items-center justify-center gap-2 w-full px-4 py-2 rounded-lg text-sm font-medium
                              border border-blue-600 text-blue-600 hover:bg-blue-50 transition-colors">
                        <i class="fas fa-external-link-alt"></i>เข้าใช้งาน
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <!-- Empty state -->
        <div class="flex flex-col items-center justify-center py-16">
            <div class="w-16 h-16 rounded-2xl bg-amber-50 flex items-center justify-center mb-4">
                <i class="fas fa-exclamation-triangle text-2xl text-amber-400"></i>
            </div>
            <h3 class="text-slate-700 font-semibold mb-1">ไม่มีระบบที่สามารถเข้าใช้งานได้</h3>
            <p class="text-sm text-slate-400">กรุณาติดต่อผู้ดูแลระบบเพื่อขอสิทธิ์การเข้าใช้งาน</p>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update last activity
    const csrfToken = document.cookie.match(/csrftoken=([^;]+)/);
    if (csrfToken) {
        fetch('{% url "update_last_activity" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken[1],
                'Content-Type': 'application/json',
            }
        }).catch(err => console.log('Activity update:', err));
    }

    console.log('Portal loaded for user: {{ user.username }}');
});
</script>
{% endblock %}
