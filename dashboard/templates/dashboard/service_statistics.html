{% extends "base.html" %}
{% load humanize %}

{% block title %}‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£{% endblock %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard:home' %}">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
                        <li class="breadcrumb-item active">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Info boxes -->
    <div class="row">
        <div class="col-12 col-sm-6 col-md-4">
            <div class="info-box">
                <span class="info-box-icon bg-gradient-primary elevation-1">
                    <i class="fas fa-calendar"></i>
                </span>
                <div class="info-box-content">
                    <span class="info-box-text">‡∏õ‡∏µ 2567</span>
                    <span class="info-box-number">{{ summary.total_2567|intcomma }}</span>
                    <div class="progress">
                        <div class="progress-bar bg-primary" style="width: 70%"></div>
                    </div>
                    <span class="progress-description">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-md-4">
            <div class="info-box">
                <span class="info-box-icon bg-gradient-success elevation-1">
                    <i class="fas fa-calendar-alt"></i>
                </span>
                <div class="info-box-content">
                    <span class="info-box-text">‡∏õ‡∏µ 2568</span>
                    <span class="info-box-number">{{ summary.total_2568|intcomma }}</span>
                    <div class="progress">
                        <div class="progress-bar bg-success" style="width: {% if summary.total_2568 > summary.total_2567 %}100{% else %}50{% endif %}%"></div>
                    </div>
                    <span class="progress-description">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-md-4">
            <div class="info-box">
                <span class="info-box-icon {% if summary.diff_percent >= 0 %}bg-gradient-info{% else %}bg-gradient-warning{% endif %} elevation-1">
                    {% if summary.diff_percent >= 0 %}
                        <i class="fas fa-arrow-up"></i>
                    {% else %}
                        <i class="fas fa-arrow-down"></i>
                    {% endif %}
                </span>
                <div class="info-box-content">
                    <span class="info-box-text">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</span>
                    <span class="info-box-number">
                        {% if summary.diff_percent > 0 %}
                            +{{ summary.diff_percent|floatformat:2 }}%
                        {% elif summary.diff_percent < 0 %}
                            {{ summary.diff_percent|floatformat:2 }}%
                        {% else %}
                            0%
                        {% endif %}
                    </span>
                    <div class="progress">
                        <div class="progress-bar {% if summary.diff_percent >= 0 %}bg-info{% else %}bg-warning{% endif %}" 
                             style="width: {% if summary.diff_percent >= 0 %}{{ summary.diff_percent|add:50 }}{% else %}{{ summary.diff_percent|add:50 }}{% endif %}%"></div>
                    </div>
                    <span class="progress-description">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <h5 class="m-0 font-weight-bold">
                        <i class="fas fa-chart-bar me-2"></i>
                        ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ 2567 vs 2568
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div id="monthlyComparisonChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="m-0 font-weight-bold">
                        <i class="fas fa-table me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2567
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-calendar me-1"></i>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                    <th class="text-end"><i class="fas fa-users me-1"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in data_2567 %}
                                <tr>
                                    <td>{{ item.month }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-primary rounded-pill">{{ item.visit_count|intcomma }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-primary fw-bold">
                                    <th><i class="fas fa-calculator me-1"></i>‡∏£‡∏ß‡∏°</th>
                                    <th class="text-end">
                                        <span class="badge bg-dark rounded-pill fs-6">{{ summary.total_2567|intcomma }}</span>
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="m-0 font-weight-bold">
                        <i class="fas fa-table me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2568
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-calendar me-1"></i>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                    <th class="text-end"><i class="fas fa-users me-1"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in data_2568 %}
                                <tr>
                                    <td>{{ item.month }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-success rounded-pill">{{ item.visit_count|intcomma }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-success fw-bold">
                                    <th><i class="fas fa-calculator me-1"></i>‡∏£‡∏ß‡∏°</th>
                                    <th class="text-end">
                                        <span class="badge bg-dark rounded-pill fs-6">{{ summary.total_2568|intcomma }}</span>
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
    const chartLabels = {{ chart_data.labels|safe }};
    const data2567 = {{ chart_data.data_2567|safe }};
    const data2568 = {{ chart_data.data_2568|safe }};
    
    // ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡πÅ‡∏ö‡∏ö Column Chart
    const comparisonOptions = {
        ...window.chartConfig,
        series: [
            {
                name: '‡∏õ‡∏µ 2567',
                data: data2567
            },
            {
                name: '‡∏õ‡∏µ 2568', 
                data: data2568
            }
        ],
        chart: {
            ...window.chartConfig.chart,
            type: 'bar',
            height: 400,
            toolbar: {
                show: false
            }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '65%',
                borderRadius: 4,
                dataLabels: {
                    position: 'top'
                }
            }
        },
        dataLabels: {
            enabled: true,
            offsetY: -20,
            style: {
                fontSize: '12px',
                colors: ['#304758']
            },
            formatter: function(val) {
                return window.chartUtils.formatDataLabelCompact(val);
            }
        },
        stroke: {
            show: true,
            width: 2,
            colors: ['transparent']
        },
        xaxis: {
            categories: chartLabels,
            title: {
                text: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                style: {
                    fontSize: '14px',
                    fontWeight: 'bold'
                }
            }
        },
        yaxis: {
            title: {
                text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
                style: {
                    fontSize: '14px',
                    fontWeight: 'bold'
                }
            },
            labels: {
                formatter: function (val) {
                    return window.chartUtils.formatNumber(val);
                }
            }
        },
        colors: ['#2563eb', '#059669'],
        fill: {
            opacity: 0.8
        },
        legend: {
            position: 'top',
            horizontalAlign: 'center',
            fontSize: '14px',
            markers: {
                width: 12,
                height: 12,
                radius: 6
            }
        },
        title: {
            text: '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
            align: 'center',
            style: {
                fontSize: '18px',
                fontWeight: 'bold',
                color: '#263238'
            }
        },
        subtitle: {
            text: '‡∏õ‡∏µ 2567 ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö ‡∏õ‡∏µ 2568',
            align: 'center',
            style: {
                fontSize: '14px',
                color: '#6c757d'
            }
        },
        tooltip: {
            shared: true,
            intersect: false,
            y: {
                formatter: function (val) {
                    return window.chartUtils.formatNumber(val) + ' ‡∏Ñ‡∏ô'
                }
            }
        },
        responsive: [{
            breakpoint: 768,
            options: {
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '80%'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü
    const comparisonChart = new ApexCharts(document.querySelector("#monthlyComparisonChart"), comparisonOptions);
    comparisonChart.render();
    
    // Register chart for export functionality
    window.registerChart('monthlyComparisonChart', comparisonChart);
    
    // Add export buttons
    setTimeout(() => {
        window.addChartExportButtons('monthlyComparisonChart', '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
    }, 500);
    
    // Debug logs
    console.log('üìä Service Statistics Charts Loaded');
    console.log('Chart data:', {{ chart_data|safe }});
    console.log('Summary:', {{ summary|safe }});
});
</script>
{% endblock %}