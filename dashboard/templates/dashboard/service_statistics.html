{% extends "base.html" %}
{% load humanize %}

{% block title %}‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ - AIMS{% endblock %}

{% block breadcrumb %}
<a href="{% url 'dashboard:home' %}" class="text-slate-400 hover:text-slate-600">Dashboard</a>
<span class="mx-2 text-slate-300">/</span>
<span class="text-slate-700 font-medium">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="mb-6">
    <h1 class="text-xl font-bold text-slate-900">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h1>
    <p class="text-sm text-slate-500 mt-1">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ 2567 vs 2568</p>
</div>

<!-- Stat Cards -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">

    <!-- ‡∏õ‡∏µ 2567 -->
    <div class="bg-white rounded-xl border border-slate-200 p-5">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-calendar text-blue-600"></i>
            </div>
            <p class="text-sm font-medium text-slate-600">‡∏õ‡∏µ 2567</p>
        </div>
        <p class="text-3xl font-bold text-slate-900 mb-1">{{ summary.total_2567|intcomma }}</p>
        <p class="text-xs text-slate-400">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <div class="mt-3 bg-slate-100 rounded-full h-1.5">
            <div class="bg-blue-500 h-1.5 rounded-full" style="width: 70%"></div>
        </div>
    </div>

    <!-- ‡∏õ‡∏µ 2568 -->
    <div class="bg-white rounded-xl border border-slate-200 p-5">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-emerald-50 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-calendar-alt text-emerald-600"></i>
            </div>
            <p class="text-sm font-medium text-slate-600">‡∏õ‡∏µ 2568</p>
        </div>
        <p class="text-3xl font-bold text-slate-900 mb-1">{{ summary.total_2568|intcomma }}</p>
        <p class="text-xs text-slate-400">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <div class="mt-3 bg-slate-100 rounded-full h-1.5">
            <div class="bg-emerald-500 h-1.5 rounded-full"
                 style="width: {% if summary.total_2568 > summary.total_2567 %}100{% else %}60{% endif %}%"></div>
        </div>
    </div>

    <!-- ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á -->
    <div class="bg-white rounded-xl border border-slate-200 p-5">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0
                {% if summary.diff_percent >= 0 %}bg-sky-50{% else %}bg-amber-50{% endif %}">
                <i class="fas {% if summary.diff_percent >= 0 %}fa-arrow-trend-up text-sky-600{% else %}fa-arrow-trend-down text-amber-600{% endif %}"></i>
            </div>
            <p class="text-sm font-medium text-slate-600">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</p>
        </div>
        <p class="text-3xl font-bold mb-1
            {% if summary.diff_percent >= 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
            {% if summary.diff_percent > 0 %}+{% endif %}{{ summary.diff_percent|floatformat:2 }}%
        </p>
        <p class="text-xs text-slate-400">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô</p>
        <div class="mt-3 bg-slate-100 rounded-full h-1.5">
            <div class="h-1.5 rounded-full
                {% if summary.diff_percent >= 0 %}bg-sky-500{% else %}bg-amber-500{% endif %}"
                 style="width: 50%"></div>
        </div>
    </div>

</div>

<!-- Monthly Comparison Chart -->
<div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-6">
    <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
        <i class="fas fa-chart-bar text-slate-400"></i>
        <h2 class="text-sm font-semibold text-slate-700">
            ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ 2567 vs 2568
        </h2>
    </div>
    <div class="p-4">
        <div id="monthlyComparisonChart" style="height: 400px;"></div>
    </div>
</div>

<!-- Data Tables (2-col) -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏µ 2567 -->
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-blue-500 flex-shrink-0"></div>
            <h2 class="text-sm font-semibold text-slate-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2567</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-100">
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    {% for item in data_2567 %}
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="px-4 py-3 text-slate-700">{{ item.month }}</td>
                        <td class="px-4 py-3 text-right">
                            <span class="font-semibold text-slate-900">{{ item.visit_count|intcomma }}</span>
                            <span class="text-slate-400 text-xs ml-1">‡∏Ñ‡∏ô</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="bg-slate-50 border-t border-slate-200">
                        <td class="px-4 py-3 font-semibold text-slate-700">
                            <i class="fas fa-calculator mr-1.5 text-slate-400"></i>‡∏£‡∏ß‡∏°
                        </td>
                        <td class="px-4 py-3 text-right font-bold text-slate-900">
                            {{ summary.total_2567|intcomma }} <span class="text-slate-400 font-normal text-xs">‡∏Ñ‡∏ô</span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏µ 2568 -->
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-emerald-500 flex-shrink-0"></div>
            <h2 class="text-sm font-semibold text-slate-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2568</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-100">
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wide">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    {% for item in data_2568 %}
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="px-4 py-3 text-slate-700">{{ item.month }}</td>
                        <td class="px-4 py-3 text-right">
                            <span class="font-semibold text-slate-900">{{ item.visit_count|intcomma }}</span>
                            <span class="text-slate-400 text-xs ml-1">‡∏Ñ‡∏ô</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="bg-slate-50 border-t border-slate-200">
                        <td class="px-4 py-3 font-semibold text-slate-700">
                            <i class="fas fa-calculator mr-1.5 text-slate-400"></i>‡∏£‡∏ß‡∏°
                        </td>
                        <td class="px-4 py-3 text-right font-bold text-slate-900">
                            {{ summary.total_2568|intcomma }} <span class="text-slate-400 font-normal text-xs">‡∏Ñ‡∏ô</span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartLabels = {{ chart_data.labels|safe }};
    const data2567 = {{ chart_data.data_2567|safe }};
    const data2568 = {{ chart_data.data_2568|safe }};

    const comparisonChart = new ApexCharts(document.querySelector('#monthlyComparisonChart'), {
        series: [
            { name: '‡∏õ‡∏µ 2567', data: data2567 },
            { name: '‡∏õ‡∏µ 2568', data: data2568 }
        ],
        chart: {
            type: 'bar',
            height: 400,
            toolbar: { show: false }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '65%',
                borderRadius: 4,
                dataLabels: { position: 'top' }
            }
        },
        dataLabels: {
            enabled: true,
            offsetY: -20,
            style: { fontSize: '11px', colors: ['#334155'] },
            formatter: val => val >= 1000 ? (val / 1000).toFixed(1) + 'k' : val.toString()
        },
        stroke: {
            show: true,
            width: 2,
            colors: ['transparent']
        },
        xaxis: {
            categories: chartLabels,
            title: { text: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', style: { fontSize: '13px', fontWeight: 'bold' } }
        },
        yaxis: {
            title: { text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', style: { fontSize: '13px', fontWeight: 'bold' } },
            labels: { formatter: val => val.toLocaleString() }
        },
        colors: ['#2563eb', '#059669'],
        fill: { opacity: 0.85 },
        legend: {
            position: 'top',
            horizontalAlign: 'center',
            fontSize: '13px',
            markers: { width: 12, height: 12, radius: 6 }
        },
        tooltip: {
            shared: true,
            intersect: false,
            y: { formatter: val => val.toLocaleString() + ' ‡∏Ñ‡∏ô' }
        },
        grid: { borderColor: '#e2e8f0', strokeDashArray: 5 },
        responsive: [{
            breakpoint: 768,
            options: {
                plotOptions: { bar: { columnWidth: '80%' } },
                dataLabels: { enabled: false },
                legend: { position: 'bottom' }
            }
        }]
    });

    comparisonChart.render();
    console.log('üìä Service Statistics Chart loaded');
});
</script>
{% endblock %}
