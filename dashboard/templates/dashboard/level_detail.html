{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ level_name }} - AIMS{% endblock %}

{% block breadcrumb %}
<a href="{% url 'dashboard:home' %}" class="text-slate-400 hover:text-slate-600">Dashboard</a>
<span class="mx-2 text-slate-300">/</span>
<a href="{% url 'dashboard:student' %}{% if selected_year %}?year={{ selected_year }}{% endif %}" class="text-slate-400 hover:text-slate-600">ข้อมูลนักศึกษา</a>
<span class="mx-2 text-slate-300">/</span>
<span class="text-slate-700 font-medium">{{ level_name }}</span>
{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-xl font-bold text-slate-900">{{ level_name }}</h1>
        <p class="text-sm text-slate-500 mt-1">รายละเอียดข้อมูลนักศึกษาในระดับการศึกษา — {{ year_filter_label }}</p>
    </div>
    <a href="{% url 'dashboard:export_level_excel' level_name %}{% if selected_year %}?year={{ selected_year }}{% endif %}"
       class="flex items-center gap-1.5 px-4 py-2 rounded-lg text-sm font-medium bg-emerald-600 text-white hover:bg-emerald-700 transition-colors">
        <i class="fas fa-file-excel"></i>Export Excel
    </a>
</div>

<!-- ============================================================
     KPI CARDS
============================================================ -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">

    <div class="bg-white rounded-xl border border-slate-200 p-5">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-user-graduate text-blue-600"></i>
            </div>
            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">นักศึกษาทั้งหมด</p>
        </div>
        <p class="text-3xl font-bold text-slate-900">{{ total_students|intcomma }}</p>
        <p class="text-xs text-slate-400 mt-1">คน ในระดับนี้</p>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 p-5">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-emerald-50 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-university text-emerald-600"></i>
            </div>
            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">คณะ</p>
        </div>
        <p class="text-3xl font-bold text-slate-900">{{ faculty_distribution|length }}</p>
        <p class="text-xs text-slate-400 mt-1">คณะที่มีนักศึกษา</p>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 p-5">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-amber-50 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-book text-amber-500"></i>
            </div>
            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">สาขาวิชา</p>
        </div>
        <p class="text-3xl font-bold text-slate-900">{{ total_programs }}</p>
        <p class="text-xs text-slate-400 mt-1">สาขา</p>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 p-5">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-sky-50 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-calendar-alt text-sky-500"></i>
            </div>
            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">ปีเข้าศึกษา</p>
        </div>
        <p class="text-3xl font-bold text-slate-900">{{ year_distribution|length }}</p>
        <p class="text-xs text-slate-400 mt-1">ช่วงปีการศึกษา</p>
    </div>

</div>

<!-- ============================================================
     DONUT CHARTS — เพศ + คณะ (2-col)
============================================================ -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

    <!-- เพศ -->
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
            <i class="fas fa-venus-mars text-blue-500"></i>
            <h2 class="text-sm font-semibold text-slate-700">สัดส่วนตามเพศ</h2>
        </div>
        <div class="p-4">
            <div id="genderChart" style="height: 260px;"></div>
            <div class="mt-4 overflow-x-auto">
                <table class="w-full text-xs">
                    <thead>
                        <tr class="bg-slate-50">
                            <th class="px-3 py-2 text-left text-slate-500 font-medium">เพศ</th>
                            <th class="px-3 py-2 text-right text-slate-500 font-medium">จำนวน (คน)</th>
                            <th class="px-3 py-2 text-right text-slate-500 font-medium">%</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {% for gender in gender_distribution %}
                        <tr class="hover:bg-slate-50/50">
                            <td class="px-3 py-2">
                                <span class="inline-flex items-center gap-1.5">
                                    {% if gender.gender == 'ชาย' %}<i class="fas fa-mars text-blue-500 text-xs"></i>
                                    {% elif gender.gender == 'หญิง' %}<i class="fas fa-venus text-pink-500 text-xs"></i>
                                    {% endif %}
                                    <span class="text-slate-700 font-medium">{{ gender.gender|default:"ไม่ระบุ" }}</span>
                                </span>
                            </td>
                            <td class="px-3 py-2 text-right font-semibold text-slate-900">{{ gender.count|intcomma }}</td>
                            <td class="px-3 py-2 text-right font-medium text-blue-600">{% widthratio gender.count total_students 100 %}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- สัดส่วนตามคณะ (donut) -->
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 flex items-center gap-2">
            <i class="fas fa-university text-amber-500"></i>
            <h2 class="text-sm font-semibold text-slate-700">สัดส่วนตามคณะ (Top 5)</h2>
        </div>
        <div class="p-4">
            <div id="facultyChart" style="height: 260px;"></div>
            <div class="mt-4 overflow-x-auto">
                <table class="w-full text-xs">
                    <thead>
                        <tr class="bg-slate-50">
                            <th class="px-3 py-2 text-left text-slate-500 font-medium">คณะ</th>
                            <th class="px-3 py-2 text-right text-slate-500 font-medium">จำนวน (คน)</th>
                            <th class="px-3 py-2 text-right text-slate-500 font-medium">%</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {% for faculty in faculty_distribution|slice:":5" %}
                        <tr class="hover:bg-slate-50/50">
                            <td class="px-3 py-2 text-slate-700 font-medium">{{ faculty.faculty_name|default:"ไม่ระบุ" }}</td>
                            <td class="px-3 py-2 text-right font-semibold text-slate-900">{{ faculty.count|intcomma }}</td>
                            <td class="px-3 py-2 text-right font-medium text-amber-600">{% widthratio faculty.count total_students 100 %}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- ============================================================
     PROGRAM TABLE (grouped by faculty)
============================================================ -->
<div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <i class="fas fa-layer-group text-emerald-500"></i>
            <h2 class="text-sm font-semibold text-slate-700">
                สาขาวิชาจำแนกตามคณะ
                <span class="ml-1 text-slate-400 font-normal">({{ total_programs }} สาขา)</span>
            </h2>
        </div>
    </div>
    <div class="overflow-x-auto">
        {% for faculty_name, programs in faculty_programs.items %}
        <!-- Faculty group header -->
        <div class="px-6 py-3 bg-emerald-50 border-b border-emerald-100 flex items-center justify-between">
            <span class="text-xs font-semibold text-emerald-700 uppercase tracking-wide">
                <i class="fas fa-university mr-1.5 text-emerald-500"></i>{{ faculty_name }}
                <span class="ml-2 font-normal text-emerald-500">({{ programs|length }} สาขา)</span>
            </span>
            <span class="text-xs font-semibold text-emerald-700">
                {% for fname, ftotal in faculty_totals.items %}{% if fname == faculty_name %}{{ ftotal|intcomma }} คน{% endif %}{% endfor %}
            </span>
        </div>
        <table class="w-full text-sm border-b border-slate-100">
            <tbody class="divide-y divide-slate-50">
                {% for program in programs %}
                <tr class="hover:bg-slate-50/50 transition-colors">
                    <td class="px-10 py-2.5 text-slate-700">{{ program.program_name|default:"ไม่ระบุ" }}</td>
                    <td class="px-4 py-2.5 text-right font-semibold text-slate-900 w-28">
                        {{ program.count|intcomma }} <span class="text-slate-400 text-xs font-normal">คน</span>
                    </td>
                    <td class="px-4 py-2.5 text-right font-medium text-emerald-600 w-16">
                        {% widthratio program.count total_students 100 %}%
                    </td>
                    <td class="px-6 py-2.5 w-40">
                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                            <div class="bg-emerald-400 h-1.5 rounded-full"
                                 style="width: {% widthratio program.count total_students 100 %}%"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                <!-- Faculty subtotal -->
                {% for fname, ftotal in faculty_totals.items %}
                {% if fname == faculty_name %}
                <tr class="bg-emerald-50/50">
                    <td class="px-10 py-2 text-xs font-semibold text-emerald-700">รวม {{ faculty_name }}</td>
                    <td class="px-4 py-2 text-right font-bold text-emerald-700 text-sm">{{ ftotal|intcomma }} <span class="text-xs font-normal">คน</span></td>
                    <td class="px-4 py-2 text-right font-bold text-emerald-700">{% widthratio ftotal total_students 100 %}%</td>
                    <td class="px-6 py-2">
                        <div class="w-full bg-emerald-100 rounded-full h-2">
                            <div class="bg-emerald-500 h-2 rounded-full" style="width: {% widthratio ftotal total_students 100 %}%"></div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}
    </div>
    <!-- Grand total footer -->
    <div class="px-6 py-3 bg-slate-900 flex items-center justify-between">
        <span class="text-sm font-semibold text-white"><i class="fas fa-calculator mr-2 text-slate-400"></i>รวมทั้งหมด ({{ level_name }})</span>
        <span class="text-sm font-bold text-white">{{ total_students|intcomma }} <span class="text-slate-400 text-xs font-normal">คน</span></span>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const genderLabels  = {{ gender_labels|safe }};
    const genderData    = {{ gender_data|safe }};
    const facultyLabels = {{ faculty_labels|safe }};
    const facultyData   = {{ faculty_data|safe }};
    const totalStudents = {{ total_students }};

    // ============================================================
    // CHART 1: Gender — Donut
    // ============================================================
    if (genderLabels.length > 0) {
        new ApexCharts(document.querySelector('#genderChart'), {
            series: genderData,
            chart: { type: 'donut', height: 260, toolbar: { show: false } },
            labels: genderLabels,
            plotOptions: {
                pie: { donut: { size: '62%', labels: { show: true, total: {
                    show: true, label: 'รวม', fontSize: '14px', fontWeight: '700', color: '#1e293b',
                    formatter: w => w.globals.seriesTotals.reduce((a, b) => a + b, 0).toLocaleString()
                }}}}
            },
            dataLabels: { enabled: true, formatter: val => Math.round(val) + '%' },
            tooltip: { y: { formatter: val => val.toLocaleString() + ' คน' } },
            legend: { position: 'bottom', fontSize: '12px' },
            colors: ['#2563eb', '#ec4899', '#94a3b8']
        }).render();
    }

    // ============================================================
    // CHART 2: Faculty — Donut (top 5)
    // ============================================================
    if (facultyLabels.length > 0) {
        const top5Labels = facultyLabels.slice(0, 5);
        const top5Data   = facultyData.slice(0, 5);
        const fColors = ['#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#06b6d4'];

        new ApexCharts(document.querySelector('#facultyChart'), {
            series: top5Data,
            chart: { type: 'donut', height: 260, toolbar: { show: false } },
            labels: top5Labels.map(l => l.length > 30 ? l.slice(0, 27) + '...' : l),
            plotOptions: {
                pie: { donut: { size: '62%', labels: { show: true, total: {
                    show: true, label: 'Top 5', fontSize: '13px', fontWeight: '700', color: '#1e293b',
                    formatter: w => w.globals.seriesTotals.reduce((a, b) => a + b, 0).toLocaleString()
                }}}}
            },
            dataLabels: { enabled: true, formatter: val => Math.round(val) + '%' },
            tooltip: { y: { formatter: val => val.toLocaleString() + ' คน' } },
            legend: { position: 'bottom', fontSize: '11px' },
            colors: fColors
        }).render();
    }

    console.log('✅ Level Detail loaded: {{ level_name }}');
});
</script>
{% endblock %}
