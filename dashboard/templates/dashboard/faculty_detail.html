{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ faculty_name }} - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ì‡∏∞{% endblock %}

{% block content %}
    
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-8">
                    <h1 class="m-0">{{ faculty_name }}</h1>
                    <p class="text-muted">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏ì‡∏∞ - {{ year_filter_label }}</p>
                </div>
                <div class="col-sm-4">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/executive/">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
                        <li class="breadcrumb-item">
                            <a href="{% url 'dashboard:student' %}{% if selected_year %}?year={{ selected_year }}{% endif %}">
                                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                            </a>
                        </li>
                        <li class="breadcrumb-item active">{{ faculty_name }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="small-box bg-gradient-primary">
                <div class="inner">
                    <h3>{{ total_students|intcomma }}</h3>
                    <p>‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                <div class="icon">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="small-box-footer">‡πÉ‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏ô‡∏µ‡πâ <i class="fas fa-check-circle"></i></div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="small-box bg-gradient-success">
                <div class="inner">
                    <h3>{{ program_distribution|length }}</h3>
                    <p>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á</p>
                </div>
                <div class="icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="small-box-footer">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ <i class="fas fa-chart-pie"></i></div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="small-box bg-gradient-info">
                <div class="inner">
                    <h3>{{ level_distribution|length }}</h3>
                    <p>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
                </div>
                <div class="icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="small-box-footer">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ <i class="fas fa-chart-bar"></i></div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="small-box bg-gradient-warning">
                <div class="inner">
                    <h3>{{ year_distribution|length }}</h3>
                    <p>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤</p>
                </div>
                <div class="icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="small-box-footer">‡∏ä‡πà‡∏ß‡∏á‡∏õ‡∏µ <i class="fas fa-clock"></i></div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <!-- Row 1: Gender and Level (col-md-6 each) -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®
                    </h5>
                </div>
                <div class="card-body">
                    <div id="genderChart" style="height: 400px;"></div>
                    
                    <!-- Gender Summary -->
                    <div class="mt-3">
                        <h6>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®:</h6>
                        {% for gender in gender_distribution %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ gender.gender|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}</span>
                            <span class="badge bg-info">{{ gender.count|intcomma }} ‡∏Ñ‡∏ô ({% widthratio gender.count total_students 100 %}%)</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-donut me-2"></i>
                        ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                    </h5>
                </div>
                <div class="card-body">
                    <div id="levelChart" style="height: 400px;"></div>
                    
                    <!-- Level Summary -->
                    <div class="mt-3">
                        <h6>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</h6>
                        {% for level in level_distribution %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ level.level_name|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}</span>
                            <span class="badge bg-warning text-dark">{{ level.count|intcomma }} ‡∏Ñ‡∏ô ({% widthratio level.count total_students 100 %}%)</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 2: Year Distribution Chart (col-md-12) -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ({{ year_distribution|length }} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤)
                    </h5>
                    <button type="button" class="btn btn-light btn-sm" onclick="exportYearData()">
                        <i class="fas fa-download me-1"></i> Export ‡∏õ‡∏µ
                    </button>
                </div>
                <div class="card-body">
                    <div id="yearChart" style="height: 400px;"></div>
                    
                    <!-- Year Summary -->
                    <div class="mt-4">
                        <h6>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="table-danger">
                                    <tr>
                                        <th width="15%" class="text-center">‡∏õ‡∏µ ‡∏û.‡∏®.</th>
                                        <th width="20%" class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                        <th width="20%" class="text-center">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</th>
                                        <th width="45%">‡πÅ‡∏ñ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for year in year_distribution %}
                                    <tr>
                                        <td class="text-center">
                                            <span class="badge bg-danger">{{ year.year|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}</span>
                                        </td>
                                        <td class="text-end">
                                            <span class="fw-bold">{{ year.count|intcomma }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="text-danger fw-bold">{% widthratio year.count total_students 100 %}%</span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-danger" 
                                                     style="width: {% widthratio year.count total_students 100 %}%">
                                                    {% widthratio year.count total_students 100 %}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 3: All Programs Chart (12md) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({{ program_distribution|length }} ‡∏™‡∏≤‡∏Ç‡∏≤)
                    </h5>
                    <button type="button" class="btn btn-light btn-sm" onclick="exportProgramData()">
                        <i class="fas fa-download me-1"></i> Export ‡∏™‡∏≤‡∏Ç‡∏≤
                    </button>
                </div>
                <div class="card-body">
                    <div id="programChart" style="height: 400px;"></div>
                    
                    <!-- All Programs Summary Table -->
                    <div class="mt-4">
                        <h6>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="table-success">
                                    <tr>
                                        <th width="6%">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                        <th width="45%">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                        <th width="20%" class="text-center">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                                        <th width="14%" class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                        <th width="15%" class="text-center">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prog in program_distribution %}
                                    <tr>
                                        <td class="text-center">
                                            <span class="badge bg-success">{{ forloop.counter }}</span>
                                        </td>
                                        <td class="program-name">{{ prog.program_name|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}</td>
                                        <td class="text-center">
                                            <span class="badge {% if prog.level_name == '‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ' %}bg-primary{% elif prog.level_name == '‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÇ‡∏ó' %}bg-warning{% elif prog.level_name == '‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÄ‡∏≠‡∏Å' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                {{ prog.level_name|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            <span class="fw-bold">{{ prog.count|intcomma }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="text-success fw-bold">{% widthratio prog.count total_students 100 %}%</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
    const genderLabels = {{ gender_labels|safe }};
    const genderData = {{ gender_data|safe }};
    const programLabels = {{ program_labels|safe }};
    const programData = {{ program_data|safe }};
    const levelLabels = {{ level_labels|safe }};
    const levelData = {{ level_data|safe }};
    const yearLabels = {{ year_labels|safe }};
    const yearData = {{ year_data|safe }};
    
    // ‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏î‡∏ô‡∏±‡∏ó - ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®
    if (genderLabels.length > 0) {
        // Show enhanced loading skeleton for pie chart
        window.enhancedLoader.showChartSkeleton('genderChart', 'pie');
        
        setTimeout(() => {
            try {
        const genderOptions = {
            series: genderData,
            chart: {
                type: 'donut',
                height: 350,
                toolbar: { show: false }
            },
            labels: genderLabels,
            plotOptions: {
                pie: {
                    donut: {
                        size: '60%',
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                                formatter: function (w) {
                                    const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    return total.toLocaleString();
                                }
                            }
                        }
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val, opts) {
                    const value = opts.w.config.series[opts.seriesIndex];
                    return value.toLocaleString();
                }
            },
            tooltip: {
                y: {
                    formatter: function(val) {
                        return val.toLocaleString() + ' ‡∏Ñ‡∏ô';
                    }
                }
            },
            legend: {
                position: 'bottom',
                fontSize: '14px'
            },
            colors: ['#2563eb', '#dc2626', '#d97706']
        };
        
        // Clear skeleton and prepare for chart
        window.enhancedLoader.prepareForChart('genderChart');
        
        const genderChart = new ApexCharts(document.querySelector("#genderChart"), genderOptions);
        genderChart.render().then(() => {
            window.enhancedLoader.showSuccess('genderChart', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏®‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            window.registerChart('genderChart', genderChart);
            window.addChartExportButtons('genderChart', '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®');
        }).catch((error) => {
            console.error('Gender Chart Error:', error);
            window.enhancedLoader.showEnhancedError('genderChart', 'data', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏®‡πÑ‡∏î‡πâ');
        });
        
            } catch (error) {
                console.error('Gender Chart Setup Error:', error);
                window.enhancedLoader.showEnhancedError('genderChart', 'server', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏®');
            }
        }, 800);
    } else {
        window.enhancedLoader.showEnhancedError('genderChart', 'data', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏®');
    }
    
    // ‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏î‡∏ô‡∏±‡∏ó - ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    if (levelLabels.length > 0) {
        window.enhancedLoader.showChartSkeleton('levelChart', 'pie');
        
        setTimeout(() => {
            try {
        const levelOptions = {
            series: levelData,
            chart: {
                type: 'donut',
                height: 350,
                toolbar: { show: false }
            },
            labels: levelLabels,
            plotOptions: {
                pie: {
                    donut: {
                        size: '60%',
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: '‡∏£‡∏ß‡∏°',
                                formatter: function (w) {
                                    const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    return total.toLocaleString();
                                }
                            }
                        }
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val) {
                    return Math.round(val) + '%'
                }
            },
            tooltip: {
                y: {
                    formatter: function(val) {
                        return val.toLocaleString() + ' ‡∏Ñ‡∏ô';
                    }
                }
            },
            legend: {
                position: 'bottom',
                fontSize: '12px'
            },
            colors: ['#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16']
        };
        
        window.enhancedLoader.prepareForChart('levelChart');
        
        const levelChart = new ApexCharts(document.querySelector("#levelChart"), levelOptions);
        levelChart.render().then(() => {
            window.enhancedLoader.showSuccess('levelChart', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            window.registerChart('levelChart', levelChart);
            window.addChartExportButtons('levelChart', '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
        }).catch((error) => {
            console.error('Level Chart Error:', error);
            window.enhancedLoader.showEnhancedError('levelChart', 'data', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ');
        });
        
            } catch (error) {
                console.error('Level Chart Setup Error:', error);
                window.enhancedLoader.showEnhancedError('levelChart', 'server', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
            }
        }, 600);
    } else {
        window.enhancedLoader.showEnhancedError('levelChart', 'data', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
    }
    
    // ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô - ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + Dynamic Height)
    if (programLabels.length > 0) {
        window.enhancedLoader.showChartSkeleton('programChart', 'bar');
        
        setTimeout(() => {
            try {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÅ‡∏ö‡∏ö Dynamic ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤
        const baseHeight = 300;
        const heightPerItem = 32;  // ‡∏™‡∏≤‡∏Ç‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô
        const minHeight = 400;
        const maxHeight = 900;
        const dynamicHeight = Math.min(maxHeight, Math.max(minHeight, programLabels.length * heightPerItem + baseHeight));
        
        console.log(`üìä Program Chart: ${programLabels.length} programs, height: ${dynamicHeight}px`);
        
        const programOptions = {
            series: [{
                name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
                data: programData
            }],
            chart: {
                type: 'bar',
                height: dynamicHeight,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    borderRadius: 6,
                    horizontal: true,
                    distributed: true,
                    barHeight: programLabels.length <= 8 ? '70%' : programLabels.length <= 15 ? '80%' : '90%'
                }
            },
            dataLabels: {
                enabled: true,
                style: {
                    colors: ['#fff'],
                    fontSize: programLabels.length <= 8 ? '13px' : programLabels.length <= 15 ? '12px' : '11px',
                    fontWeight: 'bold'
                },
                formatter: function(val) {
                    return val.toLocaleString() + ' ‡∏Ñ‡∏ô';
                }
            },
            xaxis: {
                categories: programLabels,
                title: {
                    text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏Ñ‡∏ô)',
                    style: {
                        fontSize: '14px',
                        fontWeight: '600'
                    }
                },
                labels: {
                    style: {
                        fontSize: programLabels.length <= 8 ? '12px' : '11px'
                    },
                    formatter: function(val) {
                        return val.toLocaleString();
                    }
                }
            },
            yaxis: {
                title: {
                    text: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤',
                    style: {
                        fontSize: '14px',
                        fontWeight: '600'
                    }
                },
                labels: {
                    style: {
                        fontSize: programLabels.length <= 8 ? '14px' : programLabels.length <= 15 ? '13px' : '12px',
                        fontWeight: '500'
                    },
                    formatter: function(val) {
                        // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
                        let maxLength = programLabels.length <= 8 ? 50 : programLabels.length <= 15 ? 45 : 40;
                        if (val.length > maxLength) {
                            return val.substring(0, maxLength - 3) + '...';
                        }
                        return val;
                    }
                }
            },
            grid: {
                show: true,
                borderColor: '#e0e6ed',
                strokeDashArray: 5,
                xaxis: {
                    lines: {
                        show: true
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function(val) {
                        return val.toLocaleString() + ' ‡∏Ñ‡∏ô';
                    }
                }
            },
            title: {
                text: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤',
                align: 'center',
                style: {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    color: '#059669'
                }
            },
            colors: ['#059669']
        };
        
        window.enhancedLoader.prepareForChart('programChart');
        
        const programChart = new ApexCharts(document.querySelector("#programChart"), programOptions);
        programChart.render().then(() => {
            window.enhancedLoader.showSuccess('programChart', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            window.registerChart('programChart', programChart);
            window.addChartExportButtons('programChart', '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤');
        }).catch((error) => {
            console.error('Program Chart Error:', error);
            window.enhancedLoader.showEnhancedError('programChart', 'data', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏î‡πâ');
        });
        
            } catch (error) {
                console.error('Program Chart Setup Error:', error);
                window.enhancedLoader.showEnhancedError('programChart', 'server', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤');
            }
        }, 1200);
    } else {
        window.enhancedLoader.showEnhancedError('programChart', 'data', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤');
    }
    
    // ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á - ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    if (yearLabels.length > 0) {
        window.enhancedLoader.showChartSkeleton('yearChart', 'bar');
        
        setTimeout(() => {
            try {
        const yearOptions = {
            series: [{
                name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
                data: yearData
            }],
            chart: {
                type: 'bar',
                height: 350,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    columnWidth: '75%',
                    distributed: true
                }
            },
            dataLabels: {
                enabled: true,
                style: {
                    colors: ['#fff'],
                    fontSize: '12px',
                    fontWeight: 'bold'
                },
                formatter: function(val) {
                    return val.toLocaleString();
                }
            },
            xaxis: {
                categories: yearLabels,
                title: {
                    text: '‡∏õ‡∏µ ‡∏û.‡∏®.',
                    style: {
                        fontSize: '14px',
                        fontWeight: '600'
                    }
                },
                labels: {
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            yaxis: {
                title: {
                    text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏Ñ‡∏ô)',
                    style: {
                        fontSize: '14px',
                        fontWeight: '600'
                    }
                },
                labels: {
                    formatter: function(val) {
                        return val.toLocaleString();
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function(val) {
                        return val.toLocaleString() + ' ‡∏Ñ‡∏ô';
                    }
                }
            },
            title: {
                text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
                align: 'center',
                style: {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    color: '#dc2626'
                }
            },
            colors: ['#dc2626']
        };
        
        window.enhancedLoader.prepareForChart('yearChart');
        
        const yearChart = new ApexCharts(document.querySelector("#yearChart"), yearOptions);
        yearChart.render().then(() => {
            window.enhancedLoader.showSuccess('yearChart', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            window.registerChart('yearChart', yearChart);
            window.addChartExportButtons('yearChart', '‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
        }).catch((error) => {
            console.error('Year Chart Error:', error);
            window.enhancedLoader.showEnhancedError('yearChart', 'data', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ');
        });
        
            } catch (error) {
                console.error('Year Chart Setup Error:', error);
                window.enhancedLoader.showEnhancedError('yearChart', 'server', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
            }
        }, 400);
    } else {
        window.enhancedLoader.showEnhancedError('yearChart', 'data', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
    }
    
    // Export functions
    window.exportProgramData = function() {
        const programData = [];
        {% for prog in program_distribution %}
        programData.push({
            '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö': {{ forloop.counter }},
            '‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤': '{{ prog.program_name|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}',
            '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤': '{{ prog.level_name|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }}',
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': {{ prog.count|default:0 }},
            '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô': '{% widthratio prog.count total_students 100 %}%'
        });
        {% endfor %}
        
        if (window.chartUtils && window.chartUtils.exportChart) {
            window.chartUtils.exportChart.toCSV(programData, '‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤_{{ faculty_name }}');
        } else {
            console.log('üìä Export functionality not available');
        }
    };
    
    window.exportYearData = function() {
        const yearData = [];
        {% for year in year_distribution %}
        yearData.push({
            '‡∏õ‡∏µ ‡∏û.‡∏®.': {{ year.year|default:"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }},
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': {{ year.count|default:0 }},
            '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô': '{% widthratio year.count total_students 100 %}%'
        });
        {% endfor %}
        
        if (window.chartUtils && window.chartUtils.exportChart) {
            window.chartUtils.exportChart.toCSV(yearData, '‡∏õ‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤_{{ faculty_name }}');
        } else {
            console.log('üìä Export functionality not available');
        }
    };
    
    console.log('‚úÖ Faculty Detail Dashboard loaded successfully for: {{ faculty_name }}');
});
</script>
{% endblock %}